---
title: 心知天气数据 API 服务的高并发实践
subtitle: high-concurrent-validity-4-api-in-seniverse
tags:
  - 高并发
  - 系统架构
categories: 一只代码狗的自我修养
---

[心知天气](https://www.seniverse.com/)作为国内领先的商业气象服务提供商，数据 API 产品从公司创立以来就一直扮演着很重要的角色。2009 年 API 产品初次上线，历经十年，我们不断用心迭代，已经为数百家企业客户提供稳定可靠的数据服务 530 多亿次。在我们[官网首页](https://www.seniverse.com/)一直滚动的调用量数字就实时展示了整个 API 产品的服务状态。目前，我们的 API 的 QPS 在高峰时期已经达到数千的量级，如何承载这样海量的并发请求，使客户能稳定及时的获取到所需数据自然也是技术团队一路以来不断探索的主题。

{% fullimage https://i.loli.net/2019/04/18/5cb848d30b0e4.gif, 图片显示错误, 心知天气 API 服务实时访问量 %}

<!-- more -->

## 访问量特点

天气数据的基本属性和客户本身的业务需求决定了客户来如何调用我们的数据接口。对于部分使用我们数据进行数据展示的 2C 客户而言，请求潮汐跟人的行为规律有着明显的相关性，这大致表现为白天比晚上并发量更高；而对于部分使用我们数据做数据分析和数据研究或者其他需要批量请求我们数据的客户而言，他们大多会选择在整点时刻来批量请求不同的数据，所以整点时刻往往会有突发的高峰访问量。

![API 数据服务访问量特点](https://i.loli.net/2019/04/18/5cb885ced4a0b.png)

在叠加了不同客户需求的总体 API 服务的访问量，可以看出以下几个特点：

- 以「天」为单位周期性明显
- 每天零点并发量非常高
- 整点和半点时刻存在并发小周期

## 石器时代

在创业初期，「云服务」的理念开始兴起，在斟酌优劣之后，我们选择将整个系统构建于国内最早的云服务提供商[阿里云](https://www.aliyun.com/)之上，如此一来也不必自己搭建和管理需要的硬件资源，对于创业公司而言是一个不错的选择。和大多数早期创业公司一样，囿于资源和技术积累，最早我们也是将 API 服务实例直接部署在[阿里云 ECS](https://cn.aliyun.com/product/ecs) 之上，对外通过[负载均衡 SLB](https://www.aliyun.com/product/slb) 提供统一的 API 入口。

随着我们数据种类越来越丰富、数据质量越来越好、产品使用体验也逐步迭代得更优，我们的客户数量不断增多，API 服务所需要承载的流量也持续上涨。由于我们已经构建了上述这样的基础架构体系，在并发量最高的时期，我们需要手工维护高达 40 台左右的 ECS。而每个 ECS 上有自己独立但不完全一致的运行环境，不管是应对访问量突变还是部署新的版本，都无法做到比较快速的响应。
